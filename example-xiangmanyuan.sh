#!/usr/bin/env bash

###############################################################################
# LocalSpec 完整示例：构建香满园餐饮管理系统
#
# 这个脚本演示了如何使用 LocalSpec 从零开始构建一个完整的项目
# 您可以直接运行此脚本，或逐步复制命令学习工作流
###############################################################################

set -e

# 颜色定义
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo_step() {
    echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}▶ $1${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

echo_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

echo_info() {
    echo -e "${YELLOW}ℹ️  $1${NC}"
}

###############################################################################
# 第一天：项目规划
###############################################################################

echo_step "第 1 天：项目初始化和规划"

# 1.1 初始化项目
echo_info "1.1 创建项目..."
localspec init xiangmanyuan --git
cd xiangmanyuan

echo_success "项目已创建：xiangmanyuan/"

# 1.2 创建项目宪法
echo_info "1.2 定义项目原则..."
localspec constitution "
香满园餐饮管理系统开发宪法

第一条：数据安全
- 所有用户密码使用 bcrypt 加密存储
- 敏感信息（身份证号、银行卡号）使用 AES-256 加密
- 所有 API 接口必须经过身份认证和权限验证
- 实施定期数据库备份策略（每日增量，每周全量）
- 记录所有敏感操作的审计日志

第二条：系统架构
- 采用微服务架构，按业务领域划分服务边界
- 使用 RESTful API 设计原则
- 前后端完全分离，通过 API 通信
- 支持水平扩展，无状态设计
- 使用消息队列处理异步任务

第三条：代码质量
- 所有功能模块必须编写单元测试
- 代码覆盖率不得低于 80%
- 使用 Python Type Hints 进行类型注解
- 严格遵循 PEP 8 编码规范
- 复杂业务逻辑必须添加详细注释
- 定期进行代码审查（Code Review）

第四条：开发流程
- 采用 TDD（测试驱动开发）方法
- 使用 Git Flow 分支管理策略
- 每个功能一个分支，通过 PR 合并
- 强制代码审查，至少一人 approve
- CI/CD 自动化构建和部署
- 所有 commit 必须关联 issue

第五条：性能要求
- API 响应时间 P95 < 200ms
- 数据库查询必须添加适当索引
- 使用 Redis 缓存热点数据
- 大文件上传使用分片上传
- 实施接口限流和防刷策略
"

echo_success "项目宪法已创建"

# 1.3 创建第一期功能规范（MVP）
echo_info "1.3 编写功能规范（这可能需要 1-2 分钟）..."
localspec specify "
香满园餐饮管理系统 - MVP 版本

【系统概述】
香满园是一个面向中小型餐厅的综合管理系统，帮助餐厅实现数字化运营。
第一期（MVP）聚焦核心业务流程：菜品管理、点餐下单、库存管理、报表统计。

【目标用户】
1. 超级管理员：餐厅老板，拥有所有权限
2. 店长：负责日常运营管理
3. 服务员：负责接待顾客、点餐下单
4. 厨师：查看待制作订单
5. 采购员：负责原材料采购和入库

【核心功能模块】

一、菜品管理模块

1.1 菜品信息管理
- 菜品基本信息：名称、价格、分类、描述、烹饪时间
- 多图上传：支持最多 9 张图片，首图作为主图
- 菜品状态：上架/下架/售罄
- 菜品标签：辣度（不辣/微辣/中辣/重辣）、特色（招牌/新品/折扣）、属性（素食/含海鲜/含坚果等）
- 规格管理：支持大份/中份/小份等多规格，每个规格独立定价
- 菜品搜索：支持按名称、分类、标签快速搜索

1.2 菜品分类管理
- 二级分类结构：一级分类（热菜、凉菜、主食、饮品等），二级分类（川菜、粤菜等）
- 分类排序：支持拖拽调整显示顺序
- 分类图标：每个分类可设置图标
- 批量操作：批量修改分类、批量上下架

1.3 菜品推荐
- 每日推荐：店长可设置每日特价菜
- 智能推荐：根据销量和季节推荐
- 套餐管理：组合套餐设置和优惠

二、订单处理模块

2.1 桌台管理
- 桌台信息：桌号、可容纳人数、区域（大厅/包间）
- 桌台状态：空闲/使用中/预订/打扫中
- 桌台布局：可视化桌台分布图
- 并桌/拆桌：支持灵活调整

2.2 点餐功能
- 选择桌台：服务员选择就餐桌台
- 浏览菜品：按分类浏览，支持搜索
- 加入购物车：选择菜品数量和规格
- 特殊要求：每个菜品可添加备注（少盐、不要香菜等）
- 购物车编辑：修改数量、删除菜品
- 优惠券使用：支持满减券、折扣券
- 确认下单：生成订单并提交到厨房

2.3 订单管理
- 订单状态流转：
  * 待支付：订单已创建，等待支付
  * 已支付：支付完成，发送到厨房
  * 制作中：厨房接单制作
  * 待上菜：菜品制作完成，等待服务员上菜
  * 已完成：顾客用餐完毕，订单结束
  * 已取消：订单取消（仅限待支付状态）
- 订单详情：查看完整订单信息，包括顾客、菜品、金额、时间
- 订单修改：已支付但未开始制作的订单可修改（加菜/减菜）
- 催单功能：服务员可催单，厨房收到提醒
- 订单取消：待支付订单可取消，已支付订单取消需退款

2.4 支付集成
- 多种支付方式：
  * 微信支付
  * 支付宝支付
  * 现金支付
  * 会员余额支付
  * 组合支付（如现金+余额）
- 支付状态实时更新
- 自动生成电子小票
- 支持退款：部分退款和全额退款

2.5 小票打印
- 自动打印：支付成功后自动打印小票
- 厨房单：厨房打印机接收订单详情
- 顾客小票：前台打印机打印结账单
- 小票内容：订单号、桌号、菜品、金额、支付方式、时间

三、库存管理模块

3.1 原材料管理
- 原材料信息：名称、类别、单位、供应商、成本价
- 当前库存：实时显示库存数量
- 安全库存：设置最低库存量，低于阈值自动预警
- 菜品关联：每个菜品关联所需原材料及用量
- 库存盘点：定期盘点，记录盘点差异

3.2 进货管理
- 供应商管理：供应商信息、联系方式、信用评级
- 采购申请：采购员创建采购单，店长审批
- 进货验收：收货时核对数量和质量
- 入库记录：更新库存数量，记录入库时间和单价
- 成本核算：自动计算菜品成本

3.3 出库管理
- 自动出库：订单完成后自动扣减原材料库存
- 手动出库：其他消耗（损耗、试菜等）手动记录
- 出库日志：记录每次出库的原因和数量

3.4 库存预警
- 低库存预警：库存低于安全值时通知采购员
- 过期预警：原材料接近保质期时提醒
- 滞销预警：长期未使用的原材料提示
- 预警通知：系统消息、短信、邮件多渠道通知

四、报表统计模块

4.1 营业报表
- 日报表：每日营业额、订单数、客流量、翻台率
- 周报表：每周趋势对比，同比环比分析
- 月报表：月度总结，营业额构成饼图
- 时段分析：高峰时段识别（早中晚餐分布）
- 桌台使用率：各桌台的使用频率和时长

4.2 菜品分析
- 销量排行：热销菜品 TOP 20
- 滞销预警：销量低于平均值的菜品
- 菜品利润：计算每道菜的利润率
- 分类占比：各分类销售额占比
- 新品表现：新上架菜品的销售情况

4.3 财务报表
- 收入明细：各支付渠道收入统计
- 成本分析：原材料成本、人工成本
- 利润分析：毛利润、净利润
- 客单价：平均每桌消费金额
- 会员消费：会员贡献占比

4.4 员工业绩
- 服务员业绩：接单量、销售额、好评率
- 厨师工作量：制作菜品数量、平均出餐时间
- 月度排名：员工业绩排行榜

【用户角色和权限】

1. 超级管理员
   - 所有功能权限
   - 系统配置管理
   - 员工账号管理

2. 店长
   - 查看所有报表
   - 菜品管理（增删改查）
   - 库存管理
   - 审批采购申请

3. 服务员
   - 桌台管理
   - 点餐下单
   - 订单查询
   - 打印小票

4. 厨师
   - 查看待制作订单
   - 更新订单状态（开始制作/制作完成）
   - 查看历史订单

5. 采购员
   - 查看库存
   - 创建采购单
   - 办理入库
   - 查看供应商信息

【非功能需求】

1. 性能要求
   - 系统响应时间：API 接口 P95 响应时间 < 200ms
   - 并发支持：支持至少 100 个并发用户
   - 数据加载：列表页面加载时间 < 1 秒
   - 图片上传：单张图片限制 5MB，支持多图并行上传

2. 安全要求
   - 用户认证：所有接口需要 JWT token
   - 密码强度：至少 8 位，包含字母数字
   - 防暴力破解：登录失败 5 次锁定账号 10 分钟
   - 数据加密：敏感数据加密存储
   - SQL 注入防护：使用 ORM 参数化查询
   - XSS 防护：前端输入过滤

3. 可用性要求
   - 系统可用率：99.5% （允许每月停机 3.6 小时）
   - 数据备份：每日自动备份，保留 30 天
   - 故障恢复：关键故障 1 小时内恢复
   - 操作日志：记录所有关键操作

4. 兼容性要求
   - 浏览器支持：Chrome 90+, Safari 14+, Edge 90+
   - 移动端适配：响应式设计，支持手机和平板
   - 打印机兼容：支持主流热敏打印机

【验收标准】

- [ ] 菜品管理：能完成菜品的增删改查，支持图片上传
- [ ] 分类管理：能创建二级分类，支持排序
- [ ] 桌台管理：能创建桌台，查看桌台状态
- [ ] 点餐下单：能选择桌台，添加菜品到购物车，提交订单
- [ ] 订单支付：支持微信/支付宝/现金支付，自动更新状态
- [ ] 小票打印：支付成功后自动打印小票（前台和厨房）
- [ ] 原材料：能添加原材料，关联菜品
- [ ] 库存更新：订单完成后自动扣减库存
- [ ] 库存预警：库存低于安全值时显示预警
- [ ] 进货入库：能创建采购单，办理入库，更新库存
- [ ] 日报表：能查看当日营业额、订单数
- [ ] 菜品排行：能查看热销菜品 TOP 10
- [ ] 权限控制：不同角色看到不同菜单和功能
- [ ] 响应速度：首页加载 < 1 秒，API 响应 < 200ms
- [ ] 单元测试：核心功能测试覆盖率 > 80%
"

echo_success "功能规范已生成"

# 1.4 生成技术方案（这可能需要 1-2 分钟）
echo_info "1.4 规划技术方案..."
localspec plan "
技术栈详细选型：

【后端】
1. 编程语言：Python 3.11
   - 理由：生态丰富，开发效率高，适合快速迭代

2. Web 框架：FastAPI 0.104+
   - 理由：
     * 原生支持异步，性能优秀
     * 自动生成 OpenAPI 文档
     * 内置数据验证（Pydantic）
     * 类型提示支持

3. ORM：SQLAlchemy 2.0
   - 理由：
     * 成熟稳定，功能强大
     * 支持异步操作
     * 灵活的查询构建

4. 数据库：PostgreSQL 15
   - 理由：
     * 开源免费，性能优秀
     * 强大的 JSON 支持
     * 事务可靠性高
     * 丰富的扩展（全文搜索、地理位置等）

5. 缓存：Redis 7
   - 用途：
     * Session 存储
     * 热点数据缓存（菜品信息、分类）
     * 分布式锁（防止重复支付）
     * 消息队列（订单通知）

6. 任务队列：Celery + RabbitMQ
   - 用途：
     * 异步任务（邮件发送、报表生成）
     * 定时任务（库存预警、数据备份）
     * 长时间任务（数据导入导出）

7. 认证：JWT (python-jose)
   - Token 有效期：7 天
   - 刷新机制：refresh token
   - 存储方式：Redis

8. 文件存储：
   - 本地开发：本地文件系统
   - 生产环境：阿里云 OSS / 腾讯云 COS
   - 图片处理：Pillow（缩略图、压缩）

【前端】
1. 框架：Vue 3.3 + TypeScript
   - 理由：
     * 渐进式框架，灵活易用
     * Composition API 代码组织更清晰
     * 类型安全（TypeScript）

2. UI 库：Element Plus
   - 理由：
     * 组件丰富，开箱即用
     * 中文文档友好
     * 主题定制方便

3. 状态管理：Pinia
   - 理由：
     * Vue 3 官方推荐
     * TypeScript 支持好
     * DevTools 调试方便

4. 路由：Vue Router 4
   - 路由守卫：权限控制
   - 懒加载：按需加载页面

5. HTTP 客户端：Axios
   - 拦截器：统一处理 token、错误
   - 重试机制：网络异常自动重试

6. 构建工具：Vite 4
   - 理由：
     * 开发服务器启动快
     * 热更新速度快
     * 生产构建优化好

7. CSS 方案：
   - 预处理器：SCSS
   - CSS-in-JS：不使用（性能考虑）
   - 移动端适配：rem + flexible

【数据库设计原则】
1. 表命名：小写字母 + 下划线（snake_case）
2. 主键：统一使用 UUID（避免 ID 规律被猜测）
3. 时间字段：
   - created_at：创建时间（自动填充）
   - updated_at：更新时间（自动更新）
   - deleted_at：软删除时间（NULL 表示未删除）
4. 索引策略：
   - 外键必须建索引
   - 查询频繁的字段建索引
   - 组合索引遵循最左前缀原则
5. 字符集：UTF-8MB4（支持 emoji）

【部署方案】
1. 容器化：Docker + Docker Compose
   - 服务：
     * app：FastAPI 应用（Gunicorn + Uvicorn workers）
     * db：PostgreSQL
     * redis：Redis
     * rabbitmq：RabbitMQ
     * celery-worker：Celery 工作进程
     * celery-beat：Celery 定时任务
     * nginx：反向代理 + 静态文件服务

2. 反向代理：Nginx
   - 功能：
     * HTTPS 终止
     * 静态文件服务
     * 负载均衡（多实例）
     * Gzip 压缩
     * 限流防刷

3. 进程管理：Supervisor（容器内）
   - 管理 Gunicorn 进程
   - 自动重启（异常退出）
   - 日志收集

4. 日志方案：ELK Stack
   - Elasticsearch：日志存储和搜索
   - Logstash：日志收集和转换
   - Kibana：日志可视化

5. 监控方案：Prometheus + Grafana
   - 指标收集：
     * 系统指标（CPU、内存、磁盘）
     * 应用指标（QPS、响应时间、错误率）
     * 业务指标（订单量、营业额）
   - 告警：
     * 错误率超过阈值
     * 响应时间过慢
     * 数据库连接池耗尽

【开发环境】
1. Python 环境管理：Poetry
   - 依赖锁定
   - 虚拟环境隔离

2. 代码格式化：
   - Black：自动格式化
   - isort：import 排序
   - Flake8：代码检查

3. 类型检查：Mypy
   - 静态类型检查
   - 减少运行时错误

4. 测试框架：
   - pytest：单元测试和集成测试
   - pytest-cov：测试覆盖率
   - pytest-asyncio：异步测试
   - Faker：测试数据生成

5. API 测试：
   - httpx：HTTP 客户端（同步/异步）
   - pytest fixtures：测试装置

【CI/CD】
1. 版本控制：Git + GitHub
   - 分支策略：Git Flow
   - main：主分支（生产环境）
   - develop：开发分支
   - feature/*：功能分支
   - hotfix/*：紧急修复分支

2. 持续集成：GitHub Actions
   - 触发条件：push、pull request
   - 流程：
     * 代码检查（Flake8、Mypy）
     * 单元测试（pytest）
     * 构建 Docker 镜像
     * 推送到镜像仓库

3. 持续部署：
   - 测试环境：develop 分支自动部署
   - 生产环境：main 分支手动触发

【安全方案】
1. HTTPS：Let's Encrypt 免费证书
2. CORS：配置允许的域名白名单
3. SQL 注入：ORM 参数化查询
4. XSS：前端输入过滤 + CSP 策略
5. CSRF：Double Submit Cookie
6. 敏感信息：环境变量 + Secrets 管理
7. 依赖扫描：定期更新依赖，修复安全漏洞

【第三方服务】
1. 支付：
   - 微信支付：商户平台申请
   - 支付宝：开放平台申请

2. 短信：阿里云短信服务
   - 验证码
   - 通知提醒

3. 对象存储：阿里云 OSS
   - 图片存储
   - CDN 加速

4. 监控告警：钉钉机器人
   - 系统异常通知
   - 重要事件提醒
"

echo_success "技术方案已完成"

# 1.5 分解任务
echo_info "1.5 生成任务列表..."
localspec tasks

echo_success "任务列表已生成"

###############################################################################
# 查看生成的文档
###############################################################################

echo_step "查看生成的文档"

echo_info "项目结构："
tree -L 3 .specify/

echo_info "\n宪法内容预览："
head -30 .specify/memory/constitution.md

echo_info "\n规范内容预览："
ls -lh .specify/specs/*/spec.md

echo_info "\n计划内容预览："
ls -lh .specify/specs/*/plan.md

echo_info "\n任务列表预览："
ls -lh .specify/specs/*/tasks.md

###############################################################################
# 第二天：开始实现（示例）
###############################################################################

echo_step "准备开始实现"

echo_info "
接下来的步骤（手动执行）：

1. 查看任务列表：
   cat .specify/specs/001-*/tasks.md

2. 开始实现（交互式）：
   localspec implement --interactive

3. 或者使用完整的 Spec Kit + Claude Code：
   specify init . --here --force
   claude  # 启动 Claude Code
   # 然后在 Claude 中运行：
   /speckit.specify ...
   /speckit.plan ...
   /speckit.tasks
   /speckit.implement

4. 运行测试：
   pytest tests/ -v --cov

5. 启动开发服务器：
   docker-compose up -d
   uvicorn main:app --reload

6. 访问：
   - API 文档：http://localhost:8000/docs
   - 前端页面：http://localhost:5173
"

echo_success "
✅ LocalSpec 演示完成！

📁 项目位置：$(pwd)

💡 提示：
  - 所有规范文档都在 .specify/ 目录下
  - 可以随时重新运行命令更新文档
  - 建议先查看生成的任务列表，了解实现步骤

🚀 开始编码吧！
"
